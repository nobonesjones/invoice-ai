# Invoice AI - Discount Update Bug Handover Document

## Issue Summary
When users ask to "add a discount" to an existing invoice, the AI fails to apply the discount correctly. Instead of updating the existing invoice, it either:
1. Creates a new invoice with the discount applied
2. Says "the app doesn't support adding discounts to invoices"

## Current Behavior (INCORRECT)
1. User: "Create invoice for Emily 100 cakes at $4 each"
2. AI: Successfully creates INV-079
3. User: "Add 10% discount" 
4. AI: Creates NEW invoice INV-080 with discount OR says discounts not supported

## Expected Behavior
The AI should update the existing invoice (INV-079) with the discount, NOT create a new one.

## Root Cause Analysis

### Discovery from Logs
When user says "add 10% discount", the AI calls:
- L `update_invoice_appearance` (for design/color)
- L `update_client_info` (for client data)
-  Should call: `update_invoice` (which has discount_type and discount_value parameters)

### Why This Happens
1. **Function naming confusion**: `update_invoice` is too generic - AI doesn't realize it handles discounts
2. **Missing context**: Despite having CONTEXT-AWARE UPDATE instructions, AI still creates duplicates
3. **Function description issue**: The `update_invoice` function description may not prominently mention discount capabilities

## Technical Details

### Relevant Functions
```javascript
update_invoice: {
  parameters: {
    invoice_identifier: "Invoice number or 'latest'",
    discount_type: "percentage or fixed",
    discount_value: "discount amount",
    // ... other parameters
  }
}
```

### Current Assistant Instructions
The system has CONTEXT-AWARE UPDATES section that specifically addresses this:
```
When user mentions updates WITHOUT specifying which invoice/estimate:
" ALWAYS use the most recently created/discussed document
" Use update_invoice for invoices, update_estimate for estimates
" NEVER create a new document when user wants to update existing
```

However, the AI is still not following these instructions correctly.

## Proposed Solution

### Option 1: Enhance update_invoice description
Make the function description crystal clear about discount capabilities:
- Current: "Update any aspect of an existing invoice"
- Proposed: "Update any aspect of an existing invoice including DISCOUNTS, amounts, dates, client info, etc."

### Option 2: Add explicit examples in instructions
Add discount-specific examples to the assistant instructions:
```
Examples of discount updates:
" User: "Add 10% discount" ’ update_invoice(discount_type: "percentage", discount_value: 10)
" User: "Apply $50 off" ’ update_invoice(discount_type: "fixed", discount_value: 50)
```

## Files to Update
1. `/scripts/update-assistant.js` - Contains assistant instructions
2. `/supabase/functions/ai-chat-assistants-poc/index.ts` - Contains function definitions

## Test Case
After implementing fix:
1. Create invoice: "Make invoice for test client $100"
2. Add discount: "Add 20% discount"
3. Expected: Updates existing invoice with discount
4. NOT Expected: Creates new invoice or says unsupported

## Additional Context
- Using OpenAI Assistants API v2
- Assistant ID: asst_RelDqkijLvSAXU2eCU0n8RiP
- The system uses ConversationMemory to track context but it's not preventing the issue
- Multiple similar functions (update_invoice_appearance, update_client_info) may be confusing the AI

## Next Steps
1. Update function descriptions to be more explicit about discount handling
2. Add clear examples in assistant instructions
3. Test the fix with the scenario above
4. Consider monitoring for similar context-loss issues in other operations