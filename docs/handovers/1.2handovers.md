# AI Invoice Limit Enforcement - Handover Document

## Issue Summary
**CRITICAL BUG**: The AI chat system is not enforcing the 3-invoice limit for free users, allowing unlimited invoice creation through AI despite business rules being properly implemented elsewhere in the app.

## Root Cause Analysis
The app is using the wrong AI edge function (`ai-chat-assistants-poc`) which **lacks all usage limit enforcement code**, while the correct implementations exist in unused functions.

## Current State

### What Works 
- UI components properly enforce 3-item limit (invoices + estimates)
- Manual invoice creation shows paywall when limit reached
- Business logic exists in `services/usageTrackingService.ts` and `services/invoiceFunctions.ts`
- Database schema supports limit tracking via `user_profiles` table
- Premium users get unlimited access as expected

### What's Broken L
- AI chat bypasses all limits - free users can create unlimited invoices via AI
- App routes to `ai-chat-assistants-poc` edge function which has no limit checking
- Users can circumvent paywall by using AI instead of manual creation

## Technical Details

### Active AI Configuration
- **Current Endpoint**: `ai-chat-assistants-poc` (missing business rules)
- **Routing Logic**: `assistantService.ts` ’ `chatService.ts` ’ POC endpoint
- **Environment Control**: `EXPO_PUBLIC_USE_EXPERIMENTAL_AI=false` (uses POC)

### Business Rules Implementation
- **3-Item Limit**: Free users can create max 3 total items (invoices + estimates)
- **Subscription Tiers**: `free` (default) | `premium` | `grandfathered`
- **Database Table**: `user_profiles.subscription_tier`
- **Service Methods**: `UsageService.checkInvoiceLimit()`, `InvoiceFunctionService.checkUsageLimits()`

### Missing Implementation in POC Function
The active `ai-chat-assistants-poc/index.ts` lacks:
- L `checkUsageLimits` function
- L Usage validation before invoice creation  
- L AI assistant instructions about limits
- L Subscription tier checking
- L Paywall trigger logic

### Working Implementation Reference
Functions `ai-chat/index.ts` and `ai-chat-optimized/index.ts` contain complete enforcement:
-  `checkUsageLimits()` function with database queries
-  Pre-creation validation in `createInvoice()`
-  AI system prompt with mandatory limit checking instructions
-  Proper error messages and paywall triggers

## Recommended Fix (Option 1 - Quickest)
**Port business rules to currently-used POC function**:

1. **Add checkUsageLimits function** to `ai-chat-assistants-poc/index.ts`:
   ```typescript
   async function checkUsageLimits(userId) {
     // Check subscription tier
     // Count existing invoices + estimates  
     // Return canCreate: false if >= 3 items for free users
   }
   ```

2. **Add usage validation** to invoice creation flow:
   ```typescript
   const usage = await checkUsageLimits(userId);
   if (!usage.success || !usage.data?.canCreate) {
     return limit exceeded message;
   }
   ```

3. **Add AI assistant instructions** about mandatory limit checking before creation

4. **Add function definition** to available tools for AI to call

## Alternative Options
- **Option 2**: Switch app to use `ai-chat-optimized` endpoint (requires routing changes)
- **Option 3**: Consolidate all AI functions into single properly-configured endpoint

## Files to Modify (Option 1)
- `supabase/functions/ai-chat-assistants-poc/index.ts` - Add business rule enforcement
- Reference implementations in `supabase/functions/ai-chat/index.ts` (lines 437-500) 
- Reference implementations in `supabase/functions/ai-chat-optimized/index.ts` (lines 911-990)

## Testing Requirements
1. **Free User Test**: Verify AI blocks creation after 3 total items
2. **Premium User Test**: Verify unlimited access works
3. **Limit Messages**: Verify proper paywall messages show
4. **UI Consistency**: Ensure AI limits match manual creation limits

## Priority
**HIGH** - This allows free users to bypass the core business model restriction via AI chat.

---
*Last Updated: 2025-01-26*
*Status: Ready for Implementation*